#!/usr/bin/env bash

# Battery percentage alert thresholds
FULL_PERCENTAGE=80
NOTICE_PERCENTAGE=40
WARNING_PERCENTAGE=25
DANGER_PERCENTAGE=10

# Source of battery information, populated by initialize_battery_info()
BATTERY_SOURCE=""
BATTERY_PERCENTAGE_SOURCE=""
BATTERY_CHARGING_STATUS_SOURCE=""

# Cache for the last known battery information
BATTERY_CHARGING_STATUS_CACHE="${XDG_CACHE_HOME}/battery-status"
BATTERY_PERCENTAGE_CATEGORY_CACHE="${XDG_CACHE_HOME}/battery-percentage-category"

# Temporary file to store PIDs of running forks
PIDFILE="${XDG_CACHE_HOME}/battery-monitor-pids"


########## INITIALIZATION ##########

# Initialize all battery-related items.
# If no battery is present, script will immediately exit.
function initialize_battery_info()
{
  # Check for the existence of a battery
  upower -e | grep BAT > /dev/null 2>&1
  if [[ $? -ne 0 ]]; then
    echo "No battery to monitor. Exiting..."
    exit 0
  fi

  # Kill off any stray processes of battery-monitor
  kill_previous_instances

  # Populate global battery information
  BATTERY_SOURCE=$(upower -e | grep BAT)
  local battery_name=$(upower -i $(upower -e | grep BAT) | awk '/native-path/ {print $2}')
  BATTERY_PERCENTAGE_SOURCE="/sys/class/power_supply/${battery_name}/capacity"
  BATTERY_CHARGING_STATUS_SOURCE="/sys/class/power_supply/${battery_name}/status"

  # Ensure the sources of battery information exist
  [[ ! -f "${BATTERY_PERCENTAGE_SOURCE}" ]] && echo "Initialization error - battery percentage source file not found..." && exit 1
  [[ ! -f "${BATTERY_CHARGING_STATUS_SOURCE}" ]] && echo "Initialization error - battery charging status source file not found..." && exit 1

  # Clean previous cache
  rm -f "${BATTERY_CHARGING_STATUS_CACHE}"
  rm -f "${BATTERY_PERCENTAGE_CATEGORY_CACHE}"

  # Re-populate cache
  # Populating the percentage cache with "none" will ensure that a notification appears when the script is first invoked
  echo "none" > "${BATTERY_PERCENTAGE_CATEGORY_CACHE}"
  get_current_battery_charging_status > "${BATTERY_CHARGING_STATUS_CACHE}"
}

function kill_previous_instances()
{
  if [[ -f "${PIDFILE}" ]]; then
    echo "Killing old processes..."
    while read -r pid; do
      if kill -0 "${pid}" 2>/dev/null; then
        kill "${pid}"
      fi
    done < "${PIDFILE}"
    rm -f "${PIDFILE}"
  fi
}



########## BATTERY PERCENTAGE ##########

# Retrieve the current battery charging percentage from power_supply kernel files.
function get_current_battery_percentage()
{
  if [[ -f "${BATTERY_PERCENTAGE_SOURCE}" ]]; then
    cat "${BATTERY_PERCENTAGE_SOURCE}"
  else
    echo "Percentage source file \"${BATTERY_PERCENTAGE_SOURCE}\" not found..."
    exit 1
  fi
}

# Retrieve the last known battery percentage category from the cache file.
function get_last_battery_percentage_category()
{
  if [[ -f "${BATTERY_PERCENTAGE_CATEGORY_CACHE}" ]]; then
    cat "${BATTERY_PERCENTAGE_CATEGORY_CACHE}"
  else
    echo "Percentage cache file \"${BATTERY_PERCENTAGE_CATEGORY_CACHE}\" not found..."
    exit 1
  fi
}

# Print a category based on how much charge the battery holds.
# Cache the information in ${XDG_CACHE_DIR}.
function get_current_battery_percentage_category()
{
  local -i current_percentage=$(get_current_battery_percentage)
  local category="none"

  if (( ${current_percentage} <= ${DANGER_PERCENTAGE} )); then
    category="danger"
  elif (( ${current_percentage} <= ${WARNING_PERCENTAGE} )); then
    category="warning"
  elif (( ${current_percentage} <= ${NOTICE_PERCENTAGE} )); then
    category="notice"
  elif (( ${current_percentage} >= ${FULL_PERCENTAGE} )); then
    category="full"
  fi

  echo "${category}" > "${BATTERY_PERCENTAGE_CATEGORY_CACHE}"
  echo "${category}"
}

# Notify user if the battery percentage category has changed
function notify_battery_percentage()
{
  # Do not notify when charging
  local current_charging_status=$(get_current_battery_charging_status)
  [[ "${current_charging_status}" = "Charging" ]] && return

  # Retrieve previous and current battery percentage category
  local last_percentage_category=$(get_last_battery_percentage_category)
  local current_percentage_category=$(get_current_battery_percentage_category)

  # If the current category is not "none" and the previous category != the last category, notify the user
  if [[ "${current_percentage_category}" != "none" ]] && [[ "${last_percentage_category}" != "${current_percentage_category}" ]]; then
    # Only notify when percentage category has changed
    battery_"${current_percentage_category}"
  fi
}

# Watch battery percentage source file for changes
function watch_battery_percentage()
{
  notify_battery_percentage

  while true; do
    notify_battery_percentage
    sleep 1
  done
}



########## BATTERY CHARGING STATUS ##########

# Retrieve the current battery charging status from power_supply kernel files.
# Cache the information in ${XDG_CACHE_DIR}.
function get_current_battery_charging_status()
{
  if [[ -f "${BATTERY_CHARGING_STATUS_SOURCE}" ]]; then
    cat "${BATTERY_CHARGING_STATUS_SOURCE}" > "${BATTERY_CHARGING_STATUS_CACHE}"
    cat "${BATTERY_CHARGING_STATUS_SOURCE}"
  else
    echo "Charging status source file \"${BATTERY_CHARGING_STATUS_SOURCE}\" not found..."
    exit 1
  fi
}

# Retrieve the last known battery charging status from the cache file.
function get_last_battery_charging_status()
{
  if [[ -f "${BATTERY_CHARGING_STATUS_CACHE}" ]]; then
    cat "${BATTERY_CHARGING_STATUS_CACHE}"
  else
    echo "Charging status cache file \"${BATTERY_CHARGING_STATUS_CACHE}\" not found..."
    exit 1
  fi
}

# Notify user if the charging state has changed
function notify_battery_charging_status()
{
  # Battery charging status
  local last_charging_status=$(get_last_battery_charging_status)
  local current_charging_status=$(get_current_battery_charging_status)


  if [[ "${current_charging_status}" = "Discharging" && "${last_charging_status}" != "Discharging" ]]; then
    notify NORMAL "󱟞 Battery Discharging..."
  elif [[ "${current_charging_status}" = "Charging" && "${last_charging_status}" != "Charging" ]]; then
    notify NORMAL "󰂄 Battery Charging!"
  elif [[ "${current_charging_status}" = "Not charging" && "${last_charging_status}" != "Not charging" ]]; then
    notify CRITICAL "󰂃 Battery not charging, please inspect..."
  elif [[ "${current_charging_status}" = "Full" && "${last_charging_status}" != "Full" ]]; then
    notify GOOD "󱟢 Battery Full!"
  elif [[ "${current_charging_status}" = "Unknown" && "${last_charging_status}" != "Unknown" ]]; then
    notify NORMAL "󰂑 Battery state unknown..."
  fi
}

# Watch battery charging status source file for changes
function watch_battery_charging_status()
{
  while true; do
    notify_battery_charging_status
    sleep 1
  done
}


########## BATTERY PERCENTAGE ALERTS ##########

# Notify the user that the battery is fully charged.
function battery_full()
{
  notify FULL "󱟢 Battery Full!"
}

# Notify the user with a mild battery level warning.
function battery_notice()
{
  notify NOTICE "NOTICE" "󰁽 Battery Level: $(get_current_battery_percentage)%"
}

# Notify the user with a strong battery level warning.
function battery_warning()
{
  notify WARNING "󰁼 WARNING" "Battery Level: $(get_current_battery_percentage)%"
}

# Notify the user that the battery is CRITICALLY low.
function battery_danger()
{
  notify CRITICAL "󱃍 DANGER" "Battery Level: $(get_current_battery_percentage)%"
}



########## MAIN ##########

# Initialize global battery information
initialize_battery_info

# Watch charging status + save PID
watch_battery_charging_status &
echo "$!" >> "${PIDFILE}"

# Watch percentage + save PID
watch_battery_percentage &
echo "$!" >> "${PIDFILE}"
