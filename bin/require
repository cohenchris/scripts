#!/usr/bin/env bash

# Check for the existence of something
#
# require [TYPE] [THING]
#   TYPE  - type of check (variable, file, or directory)
#   THING - thing which we will check the existence of
#
# if TYPE == "var"    - interpret *THING* as a variable, check that the variable is not empty
# if TYPE == "file"   - interpret *THING* as a file path, check that the file exists
# if TYPE == "dir"    - interpret *THING* as a directory path, check that the directory exists
#
# Example commands:
#   require dir /path/to/dir
#   require file /path/to/file.txt
#   require var "${ENV_VAR}"
#   require dir user@host:/path/to/dir
#   require file user@host:/path/to/file.txt


# Type of check to perform
TYPE=""
# Variable, file, or directory to check
THING=""
# Remote host where the check will be performed
# If empty, check locally
REMOTE_HOST=""


# Parse for remote (SSH) format
# For example, if THING is in the format "user@host:/path/to/thing",
# REMOTE_HOST="user@host"
# THING="/path/to/thing"
function parse_for_remote_format()
{
  # Check for SSH format
  if [[ "${THING}" =~ ^([^@]+@[^:]+):(.+)$ ]]; then
    REMOTE_HOST="${BASH_REMATCH[1]}"
    THING="${BASH_REMATCH[2]}"
  fi

  # If remote host is set, check that it is accessible
  if [[ -n "${REMOTE_HOST}" ]]; then
    ssh -o ConnectTimeout=5 "${REMOTE_HOST}" ls > /dev/null 2>&1
    if [[ $? -ne 0 ]]; then
      echo "ERROR: Host ${REMOTE_HOST} is not accessible"
      exit 1
    fi
  fi
}


# Check for the existence of an environment variable
function check_var()
{
  if [[ -z "${THING}" ]]; then
    # Log thing and calling function name
    echo -e "ERROR - variable \"${THING}\" is not set - required by ${FUNCNAME[1]:-env}"
    exit 1
  fi
}


# Check for the existence of a directory
function check_dir()
{
  local check_dir_cmd=""
  local display_path=""

  if [[ -z "${REMOTE_HOST}" ]]; then
    # Remote host is empty, check for file locally
    check_dir_cmd="[[ -d ${THING} ]]"
    display_path="${THING}"
  else
    # Check for file remotely
    check_dir_cmd="ssh -o BatchMode=yes -o ConnectTimeout=5 \"${REMOTE_HOST}\" \"[[ -d ${THING} ]]\""
    display_path="${REMOTE_HOST}:${THING}"
  fi

  # Check for the existence of a directory
  if ! eval "${check_dir_cmd}" 2>/dev/null; then
    # Log thing and calling function name
    echo -e "ERROR - directory \"${display_path}\" does not exist - required by ${FUNCNAME[1]:-env}"
    exit 1
  fi
}


# Check for the existence of a file
function check_file()
{
  local check_file_cmd=""
  local check_ownership_cmd=""
  local ownership=""
  local check_permissions_cmd=""
  local permissions=""
  local display_path=""

  if [[ -z "${REMOTE_HOST}" ]]; then
    # Remote host is empty, check for file locally
    check_file_cmd="[[ -f \"${THING}\" ]]"
    check_ownership_cmd="stat -c \"%U:%G\" \"${THING}\""
    check_permissions_cmd="stat -c \"%a\" \"${THING}\""
    display_path="${THING}"
  else
    # Check for file remotely
    check_file_cmd="ssh -o BatchMode=yes -o ConnectTimeout=5 \"${REMOTE_HOST}\" \"[[ -f ${THING} ]]\""
    check_ownership_cmd="ssh -o BatchMode=yes \"${REMOTE_HOST}\" \"stat -c '%U:%G' ${THING}\""
    check_permissions_cmd="ssh -o BatchMode=yes \"${REMOTE_HOST}\" \"stat -c '%a' ${THING}\""
    display_path="${REMOTE_HOST}:${THING}"
  fi

  # Check for the existence of a file
  if ! eval "${check_file_cmd}" 2>/dev/null; then
    # Log thing and calling function name
    echo -e "ERROR - file \"${display_path}\" does not exist - required by ${FUNCNAME[1]:-env}"
    exit 1

  # Additional checks for password files
  elif [[ "${THING}" == *"pass"* ]]; then
    # Check ownership
    ownership=$(eval "${check_ownership_cmd}" 2>/dev/null)
    if [[ "${ownership}" != "root:root" ]]; then
      echo "WARNING: Unsafe ownership for password file \"${display_path}\"."
      echo "Recommended to run 'chown root:root' on file"
    fi

    # Check permission bits
    permissions=$(eval "${check_permissions_cmd}" 2>/dev/null)
    if [[ "${permissions}" -ne 400 ]]; then
      echo "WARNING: Unsafe permissions set for password file \"${display_path}\"."
      echo "Recommended to run 'chmod 400' on file"
    fi
  fi
}


# Delegate the command handler based on what the user has provided
function handle_require_command()
{
  TYPE="${1}"
  THING="${2}"

  if [[ "${TYPE}" == "var" ]]; then
    check_var

  elif [[ "${TYPE}" == "dir" ]]; then
    parse_for_remote_format
    check_dir

  elif [[ "${TYPE}" == "file" ]]; then
    parse_for_remote_format
    check_file

  else
    # Invalid type provided
    echo "Invalid type passed to ${FUNCNAME[1]:-env} - \"${TYPE}\""
    exit 1
  fi
}


if [[ "$#" -eq 2 ]]; then
  handle_require_command "${1}" "${2}"
else
  echo "Usage: require [TYPE] [THING]"
  exit 1
fi
