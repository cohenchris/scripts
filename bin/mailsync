#!/bin/bash

notify NORMAL "Syncing new mail" "Please wait..."

# Sync from remote store to local store
mbsync -c ${MBSYNC_CONFIG} mail
if ! [[ $? -eq 0 ]]; then
  notify CRITICAL "Email syncing error" "mbsync failed..."
  exit
fi

# Index all new mail
notmuch new
if ! [[ $? -eq 0 ]]; then
  notify CRITICAL "Email syncing error" "notmuch new failed..."
  exit
fi

# Sync contacts and calendar from CardDAV server
vdirsyncer sync
if ! [[ $? -eq 0 ]]; then
  # Maybe vCards aren't initialized, try discover
  yes | vdirsyncer discover
  if ! [[ $? -eq 0 ]]; then
    notify CRITICAL "Email syncing error" "vdirsyncer failed..."
    exit
  fi

  # Try sync again
  vdirsyncer sync
  if ! [[ $? -eq 0 ]]; then
    notify CRITICAL "Email syncing error" "vdirsyncer failed..."
    exit
  fi
fi

unread_messages_count=$(notmuch count 'tag:unread')
if [ ${unread_messages_count} -eq 0 ]; then
  notify LOW "Mailbox sync complete" "No new messages :)"
elif [ ${unread_messages_count} -eq 1 ]; then
  notify NORMAL "Mailbox sync complete" "You have 1 unread message..."
else
  notify NORMAL "Mailbox sync complete" "You have ${unread_messages_count} unread messages..."
fi
